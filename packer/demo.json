{
  "variables": {
    "upgrade": "0"
  },
  "builders": [
    {
      "type":         "null",
      "communicator": "ssh",
      "ssh_host":     "104.199.88.19",
      "ssh_username": "jpasqualini75",
      "ssh_private_key_file": "{{ user `ssh_private_key_file` }}"
    }
  ],
  "provisioners" : [
    {
      "type": "file",
      "source": "Makefile",
      "destination": "~/Makefile"
    },
    {
      "type": "file",
      "source": "requirements.txt",
      "destination": "~/requirements.txt"
    },
    {
      "type": "file",
      "source": "ansible/requirements-ansible.yml",
      "destination": "~/requirements-ansible.yml"
    },
    {
      "type": "file",
      "source": "scripts/",
      "destination": "/tmp/"
    },
    {
      "type": "shell",
      "inline": [
        "PACKER_UPGRADE={{ user `upgrade` }}",
        "sudo bash -c \"echo '%admin ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers.d/yolo\"",
        "sudo chown root.root /etc/sudoers.d/yolo && sudo chmod 0440 /etc/sudoers.d/yolo",
        "[[ $PACKER_UPGRADE -eq 1 ]] && sudo yum update -y",
        "sudo apt-get install -y python-setuptools python-pip python-dev libffi-dev libssl-dev libxml2-dev libxslt1-dev libjpeg8-dev zlib1g-dev",
        "sudo easy_install pip",
        "make -f ~/Makefile install-ansible"
      ]
    },
    {
      "type": "shell-local",
      "command": "find ansible/vendor/roles/ -type l | xargs -I % -n 1 unlink %"
    },
    {
      "type": "ansible-local",
      "command": "~/.local/bin/ansible-playbook",
      "playbook_file": "./ansible/playbook.yml",
      "playbook_dir": "./ansible",
      "inventory_groups" : "app-symfony"
    }
  ]
}